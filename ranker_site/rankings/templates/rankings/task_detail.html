{% extends 'base.html' %}

{% block page_content %}
  <div class="container">
    <h2>Task</h2>

    <div class="task-content">
      {% for word in task.content.split %}
        <button class="word-button" onclick="toggleButtonColor(this)">{{ word }}</button>
      {% endfor %}
    </div>

    <button class="submit-button" onclick="submitOrder()">Submit order</button>
  </div>

  <script>
    var selectedWords = [];

    function toggleButtonColor(button) {
      if (button.classList.contains('selected')) {
        button.classList.remove('selected');
        var index = selectedWords.indexOf(button.textContent);
        if (index !== -1) {
          selectedWords.splice(index, 1);
        }
      } else {
        button.classList.add('selected');
        selectedWords.push(button.textContent);
      }
    }

    function submitOrder() {
      // Get the user ID and task ID from your backend or any appropriate source
      var userId = "{{ user_id }}"
      var taskId = "{{ task.id }}";

      // Prepare the order data to be sent to the server
      var orderData = {
        userId: userId,
        taskId: taskId,
        selectedWords: selectedWords
      };

      var csrftoken = getCookie('csrftoken');

      // Send the order data to the server
      // You can use AJAX, fetch, or any other method to send the data
      // Here, we'll use fetch as an example
      fetch('/rankings/submit_task', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(orderData)
      })
        .then(response => {
          if (response.ok) {
            // Parse the response JSON
            return response.json();
          } else {
            throw new Error('Failed to submit the order.');
          }
        })
        .then(data => {
          // Access the score value from the response JSON
          var score = data.score;
          console.log('Order submitted successfully! Score:', score);
<!--          console.log('user id', userId);-->
          // Redirect to the score_task page
          window.location.href = `/rankings/score_task/?task_id=${taskId}&score=${score}`;
        })
        .catch(error => {
          console.error('An error occurred while submitting the order:', error);
          // Handle the error condition appropriately
        });
    }

  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  </script>

  <style>
    .selected {
      background-color: yellow;
    }
  </style>
{% endblock %}